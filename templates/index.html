<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Préstamos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body.dark-mode {
            background-color: #121212;
            color: #ffffff;
        }

        .dark-mode .form-control,
        .dark-mode .form-select {
            background-color: #1e1e1e;
            color: #ffffff;
        }

        .dark-mode .table {
            color: #ffffff;
        }
    </style>
</head>

<body>
    <div class="container py-5">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h1>Calculadora de Préstamos</h1>
            <button class="btn btn-secondary" onclick="toggleDarkMode()">Modo Claro/Oscuro</button>
        </div>

        <div class="row g-3 mb-4">
            <div class="col-md-4">
                <label for="monto" class="form-label">Monto del préstamo</label>
                <input type="number" class="form-control" id="monto">
            </div>
            <div class="col-md-4">
                <label for="interes" class="form-label">Interés anual (%)</label>
                <input type="number" class="form-control" id="interes">
            </div>
            <div class="col-md-4">
                <label for="plazo" class="form-label">Plazo (meses)</label>
                <input type="number" class="form-control" id="plazo">
            </div>
            <div class="col-md-4">
                <label for="sistema" class="form-label">Sistema de amortización</label>
                <select class="form-select" id="sistema">
                    <option value="frances">Francés</option>
                    <option value="aleman">Alemán</option>
                    <option value="americano">Americano</option>
                </select>
            </div>
        </div>

        <button class="btn btn-primary mb-4" onclick="calcularCuotas()">Calcular</button>
        <canvas id="grafico" class="mb-4"></canvas>

        <div class="table-responsive">
            <table class="table table-bordered">
                <thead class="table-dark">
                    <tr>
                        <th>Mes</th>
                        <th>Cuota</th>
                        <th>Interés</th>
                        <th>Amortización</th>
                        <th>Saldo</th>
                    </tr>
                </thead>
                <tbody id="tabla"></tbody>
            </table>
        </div>

        <button class="btn btn-success" onclick="exportarExcel()">Exportar a Excel</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script>
        let chart;

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
        }

        function calcularCuotas() {
            const monto = parseFloat(document.getElementById("monto").value);
            const interes = parseFloat(document.getElementById("interes").value) / 100 / 12;
            const plazo = parseInt(document.getElementById("plazo").value);
            const sistema = document.getElementById("sistema").value;

            let saldo = monto;
            let cuotas = [], intereses = [], amortizaciones = [], saldos = [];

            if (sistema === "frances") {
                const cuota = monto * interes / (1 - Math.pow(1 + interes, -plazo));
                for (let i = 1; i <= plazo; i++) {
                    const interesMensual = saldo * interes;
                    const amortizacion = cuota - interesMensual;
                    saldo -= amortizacion;
                    cuotas.push(cuota);
                    intereses.push(interesMensual);
                    amortizaciones.push(amortizacion);
                    saldos.push(saldo);
                }
            } else if (sistema === "aleman") {
                const amortizacionConstante = monto / plazo;
                for (let i = 1; i <= plazo; i++) {
                    const interesMensual = saldo * interes;
                    const cuota = amortizacionConstante + interesMensual;
                    saldo -= amortizacionConstante;
                    cuotas.push(cuota);
                    intereses.push(interesMensual);
                    amortizaciones.push(amortizacionConstante);
                    saldos.push(saldo);
                }
            } else if (sistema === "americano") {
                for (let i = 1; i < plazo; i++) {
                    const interesMensual = monto * interes;
                    cuotas.push(interesMensual);
                    intereses.push(interesMensual);
                    amortizaciones.push(0);
                    saldos.push(monto);
                }
                const interesFinal = monto * interes;
                cuotas.push(monto + interesFinal);
                intereses.push(interesFinal);
                amortizaciones.push(monto);
                saldos.push(0);
            }

            mostrarTabla(cuotas, intereses, amortizaciones, saldos);
            mostrarGrafico(cuotas);
        }

        function mostrarTabla(cuotas, intereses, amortizaciones, saldos) {
            const tbody = document.getElementById("tabla");
            tbody.innerHTML = "";
            cuotas.forEach((cuota, i) => {
                tbody.innerHTML += `<tr>
                    <td>${i + 1}</td>
                    <td>${cuota.toFixed(2)}</td>
                    <td>${intereses[i].toFixed(2)}</td>
                    <td>${amortizaciones[i].toFixed(2)}</td>
                    <td>${saldos[i].toFixed(2)}</td>
                </tr>`;
            });
        }

        function mostrarGrafico(cuotas) {
            const ctx = document.getElementById('grafico').getContext('2d');
            if (chart) chart.destroy();
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: cuotas.map((_, i) => i + 1),
                    datasets: [{
                        label: 'Cuota mensual',
                        data: cuotas,
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1
                    }]
                }
            });
        }

        function exportarExcel() {
            const tabla = document.getElementById("tabla");
            const wb = XLSX.utils.table_to_book(tabla, { sheet: "Amortización" });
            XLSX.writeFile(wb, "amortizacion.xlsx");
        }
    </script>
</body>

</html>
